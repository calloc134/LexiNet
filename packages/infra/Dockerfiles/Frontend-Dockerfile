# パッケージの存在するパス
ARG PACKAGE_PATH=../../packages/frontend

# nodeイメージを利用
FROM node:latest as fetch-stage

# 作業ディレクトリを指定
WORKDIR /home

# pnpmに切り替える
RUN corepack enable pnpm
RUN corepack prepare pnpm@latest --activate

# 依存関係をフェッチする
COPY ../${PACKAGE_PATH}/pnpm-lock.yaml ./
RUN pnpm fetch --prod ./

# ビルド用ステージ
FROM node:latest as build-stage

# 作業ディレクトリを指定
WORKDIR /home

# データの引継ぎ
COPY --from=fetch-stage /home/node_modules ./node_modules
COPY --from=fetch-stage /home/pnpm-lock.yaml ./pnpm-lock.yaml
COPY ../${PACKAGE_PATH}/ ./

# pnpmに切り替える
RUN corepack enable pnpm
RUN corepack prepare pnpm@latest --activate

# 依存関係をインストールする
RUN pnpm i --offline --prod --frozen-lockfile

# ビルドする
RUN pnpm build